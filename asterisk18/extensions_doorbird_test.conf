[doorbird-in]
exten => 7600,1,NoOp(DoorBird->Asterisk18 test fanout)
 same => n,Progress()
 same => n,Dial(SIP/g1_23&SIP/g1_53,45)
 same => n,Hangup()

exten => 7601,1,NoOp(DoorBird->Asterisk18 single leg g1_23)
 same => n,Progress()
 same => n,Dial(SIP/g1_23,45)
 same => n,Hangup()

exten => 7602,1,NoOp(DoorBird->Asterisk18 single leg g1_53)
 same => n,Progress()
 same => n,Dial(SIP/g1_53,45)
 same => n,Hangup()

exten => 7610,1,NoOp(DoorBird->Asterisk18 via Kamailio/RTPengine fanout)
 same => n,Progress()
 same => n,Dial(SIP/7000@kproxy,45)
 same => n,Hangup()

exten => 7620,1,NoOp(DoorBird->Asterisk18 explicit dual legs via kproxy)
 same => n,Progress()
 same => n,Dial(SIP/7000@kproxy&SIP/7002@kproxy,45)
 same => n,Hangup()

exten => 7621,1,NoOp(DoorBird->Asterisk18 single via kproxy route 7000)
 same => n,Progress()
 same => n,Dial(SIP/7000@kproxy,45)
 same => n,Hangup()

exten => 7622,1,NoOp(DoorBird->Asterisk18 single via kproxy route 7002)
 same => n,Progress()
 same => n,Dial(SIP/7002@kproxy,45)
 same => n,Hangup()

; Variant-2 POC: Kamailio forks to two separate Asterisk single-leg entries
exten => 7701,1,NoOp(Variant2 leg A -> G1_23)
 same => n,Progress()
 same => n,Dial(SIP/g1_23,45)
 same => n,Hangup()

exten => 7702,1,NoOp(Variant2 leg B -> G1_53)
 same => n,Progress()
 same => n,Dial(SIP/g1_53,45)
 same => n,Hangup()

; DoorBird main call: stay in conference and start preview service in parallel.
exten => 7800,1,NoOp(DoorBird trigger -> conference + preview service)
 same => n,Answer()
 same => n,Log(NOTICE,DBDBG 7800 start chan=${CHANNEL(name)} sipcallid=${SIPCALLID})
 same => n,Set(DB_ROOM=doorbird-main)
 same => n,Set(DB_TOKEN=${UNIQUEID})
 same => n,Set(DB(doorbird/token)=${DB_TOKEN})
 same => n,Set(DB(doorbird/main_chan)=${CHANNEL(name)})
 same => n,Set(DB(doorbird/accepted)=0)
 same => n,Set(DB(doorbird/winner)=none)
 same => n,Set(CHANNEL(hangup_handler_push)=doorbird-cleanup,s,1(main))
 same => n,TrySystem(sudo -n rm -f /tmp/doorbird_preview_winner)
 same => n,TrySystem(sudo -n systemctl start --no-block doorbird-preview-live.service)
 same => n,ConfBridge(${DB_ROOM},doorbird_bridge,doorbird_user)
 same => n,Set(DB(doorbird/winner)=none)
 same => n,Set(DB(doorbird/accepted)=0)
 same => n,Hangup()

; Preview leg A (from local preview service) -> G1_23.
; On answer, called G1 channel is moved into DoorBird conference.
exten => 7901,1,NoOp(Preview leg A -> G1_23)
 same => n,Answer()
 same => n,Set(CHANNEL(hangup_handler_push)=dbg-hangup,s,1(7901))
 same => n,Set(DB(doorbird/svc_chan_23)=${CHANNEL(name)})
 same => n,Log(NOTICE,DBDBG 7901 svc_chan=${CHANNEL(name)} sipcallid=${SIPCALLID})
 same => n,Dial(SIP/g1_23,45,G(postanswer^23svc^1))
 same => n,Hangup()

; Preview leg B (from local preview service) -> G1_53.
exten => 7902,1,NoOp(Preview leg B -> G1_53)
 same => n,Answer()
 same => n,Set(CHANNEL(hangup_handler_push)=dbg-hangup,s,1(7902))
 same => n,Set(DB(doorbird/svc_chan_53)=${CHANNEL(name)})
 same => n,Log(NOTICE,DBDBG 7902 svc_chan=${CHANNEL(name)} sipcallid=${SIPCALLID})
 same => n,Dial(SIP/g1_53,45,G(postanswer^53svc^1))
 same => n,Hangup()

[joinconf]
exten => s,1,NoOp(Move answered G1 channel into conference candidate=${ARG1})
 same => n,Set(CUR_WINNER=${DB(doorbird/winner)})
 same => n,GotoIf($["${CUR_WINNER}"="none" | "${CUR_WINNER}"="${ARG1}"]?claim:reject)
 same => n(claim),Set(DB(doorbird/winner)=${ARG1})
 same => n,TrySystem(sudo -n sh -c 'echo ${ARG1} > /tmp/doorbird_preview_winner')
 same => n,Set(SVC_CHAN=${DB(doorbird/svc_chan_${ARG1})})
 same => n,Set(CHANNEL(hangup_handler_push)=dbg-hangup,s,1(joinconf-${ARG1}))
 same => n,NoOp(joinconf candidate=${ARG1} svc_chan=${SVC_CHAN} chan=${CHANNEL(name)})
 same => n,Log(NOTICE,DBDBG joinconf claim candidate=${ARG1} this=${CHANNEL(name)} svc=${SVC_CHAN} winner=${CUR_WINNER})
 same => n,ExecIf($["${SVC_CHAN}" != ""]?ChannelRedirect(${SVC_CHAN},joinsvc,s,1))
 same => n,ConfBridge(doorbird-main,doorbird_bridge,doorbird_user)
 same => n,Return()
same => n(reject),NoOp(Allowing second answered leg (debug): winner=${CUR_WINNER} candidate=${ARG1})
same => n,Log(NOTICE,DBDBG joinconf reject candidate=${ARG1} this=${CHANNEL(name)} winner=${CUR_WINNER})
same => n,Return()

[joinsvc]
exten => s,1,NoOp(Service leg joins conference as marked video source)
 same => n,Set(CHANNEL(hangup_handler_push)=dbg-hangup,s,1(joinsvc))
 same => n,Log(NOTICE,DBDBG joinsvc enter this=${CHANNEL(name)} sipcallid=${SIPCALLID})
 same => n,ConfBridge(doorbird-main,doorbird_bridge,doorbird_preview_user)
 same => n,Return()

[postanswer]
; G() transfer target:
; priority 1 is caller leg (service), priority 2 is called leg (G1)
exten => 23svc,1,Goto(pa-common,23svc,1)
exten => 23svc,2,Goto(pa-common,23g1,1)
exten => 53svc,1,Goto(pa-common,53svc,1)
exten => 53svc,2,Goto(pa-common,53g1,1)

[pa-common]
exten => 23svc,1,Set(CAND=23)
 same => n,Set(PA_ROLE=svc)
 same => n,Goto(s,1)
exten => 23g1,1,Set(CAND=23)
 same => n,Set(PA_ROLE=g1)
 same => n,Goto(s,1)
exten => 53svc,1,Set(CAND=53)
 same => n,Set(PA_ROLE=svc)
 same => n,Goto(s,1)
exten => 53g1,1,Set(CAND=53)
 same => n,Set(PA_ROLE=g1)
 same => n,Goto(s,1)

exten => s,1,NoOp(Postanswer common cand=${CAND} role=${PA_ROLE} this=${CHANNEL(name)})
 same => n,Set(CHANNEL(hangup_handler_push)=dbg-hangup,s,1(postanswer-${CAND}-${PA_ROLE}))
 same => n,Set(CUR_WINNER=${DB(doorbird/winner)})
 same => n,GotoIf($["${CUR_WINNER}"="none"]?claim:check)
 same => n(claim),Set(DB(doorbird/winner)=${CAND})
 same => n,TrySystem(sudo -n sh -c 'echo ${CAND} > /tmp/doorbird_preview_winner')
 same => n(check),Set(CUR_WINNER=${DB(doorbird/winner)})
 same => n,Log(NOTICE,DBDBG postanswer common cand=${CAND} role=${PA_ROLE} winner=${CUR_WINNER} this=${CHANNEL(name)})
 same => n,GotoIf($["${CUR_WINNER}"="${CAND}"]?join:reject)
 same => n(join),GotoIf($["${PA_ROLE}"="svc"]?join-svc:join-g1-mark)
 same => n(join-svc),ConfBridge(doorbird-main,doorbird_bridge,doorbird_preview_user)
 same => n,Hangup()
 same => n(join-g1-mark),Set(DB(doorbird/accepted)=1)
 same => n,TrySystem(sudo -n sh -c "/home/config/doorbird_conf_guard.sh talk ${DB(doorbird/token)} 60 >/tmp/doorbird-guard-talk.log 2>&1 &")
 same => n,Set(CHANNEL(hangup_handler_push)=doorbird-cleanup,s,1(g1-${CAND}))
 same => n(join-g1),ConfBridge(doorbird-main,doorbird_bridge,doorbird_user)
 same => n,Hangup()
 same => n(reject),Hangup(486)

[doorbird-cleanup]
exten => s,1,NoOp(DoorBird cleanup tag=${ARG1} this=${CHANNEL(name)})
 same => n,Log(NOTICE,DBDBG cleanup tag=${ARG1} this=${CHANNEL(name)} winner=${DB(doorbird/winner)} accepted=${DB(doorbird/accepted)})
 same => n,ExecIf($["${ARG1}"="main"]?Set(DB(doorbird/winner)=none))
 same => n,ExecIf($["${ARG1}"="main"]?Set(DB(doorbird/accepted)=0))
 same => n,ExecIf($["${ARG1}"="main"]?Set(DB(doorbird/token)=none))
 same => n,ExecIf($["${ARG1}"="main"]?Set(DB(doorbird/main_chan)=))
 same => n,ExecIf($["${ARG1}"="main"]?TrySystem(sudo -n systemctl stop --no-block doorbird-preview-live.service))
 same => n,ExecIf($[${REGEX("^g1-" ${ARG1})}]?Set(DB(doorbird/accepted)=0))
 same => n,ExecIf($[${REGEX("^g1-" ${ARG1})}]?TrySystem(sudo -n sh -c "/home/config/doorbird_conf_guard.sh post ${DB(doorbird/token)} 10 >/tmp/doorbird-guard-post.log 2>&1 &"))
 same => n,Return()

[dbg-hangup]
exten => s,1,NoOp(Hangup trace tag=${ARG1} this=${CHANNEL(name)} cause=${HANGUPCAUSE} peer=${BRIDGEPEER})
 same => n,Log(NOTICE,DBDBG hangup tag=${ARG1} this=${CHANNEL(name)} cause=${HANGUPCAUSE} peer=${BRIDGEPEER} sipcallid=${SIPCALLID})
 same => n,Return()
